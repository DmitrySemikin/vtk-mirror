#!/bin/bash
# check if oprofile and oreport is installed
hash operf 2>/dev/null || { echo >&2 "I require operf but it's not installed.  Aborting."; exit 1; }
hash opreport 2>/dev/null || { echo >&2 "I require opreport but it's not installed.  Aborting."; exit 1; }


BIN_PATH=../../../bin/
TEST_PROGRAM_NAME="SMPThreadedImageAlgorithm"

O_PROFILE_ENABLE=$1
TEST_PROGRAM_NUMBER=$2
ENABLESMP=$3
ENABLE_SMP_BLOCK_MODE=$4
THREAD_NUMBER=$5
SPLIT_SMP_BLOCKS=$6
WORK_LOAD=$7
O_PERF_EVENTS="$8"
ROOT_FOLDER="$9"
ADDITIONAL_DATA="${10}"
echo $ADDITIONAL_DATA

NUMBER_OF_ITERATIONS=5 #this is hardcoded in the forloop below

#O_PERF_EVENTS="CPU_CLK_UNHALTED:100000,L2_LINES_IN:100000:0xf0" #This depends on the cpu configuration

REPORT_NAME=Run:${TEST_PROGRAM_NAME}-${TEST_PROGRAM_NUMBER}-${SPLIT_SMP_BLOCKS}-${THREAD_NUMBER}-${WORK_LOAD}-${NUMBER_OF_ITERATIONS}

for i in 1 2 3 4 5
do
   if [ $O_PROFILE_ENABLE -eq 0 ]; then
      $BIN_PATH$TEST_PROGRAM_NAME $TEST_PROGRAM_NUMBER $ENABLESMP $ENABLE_SMP_BLOCK_MODE $THREAD_NUMBER $SPLIT_SMP_BLOCKS $WORK_LOAD $ADDITIONAL_DATA
   else
     operf $O_PERF_EVENTS $BIN_PATH$TEST_PROGRAM_NAME $TEST_PROGRAM_NUMBER $ENABLESMP $ENABLE_SMP_BLOCK_MODE $THREAD_NUMBER $SPLIT_SMP_BLOCKS $WORK_LOAD $ADDITIONAL_DATA
     opreport --callgraph -o $ROOT_FOLDER/$i${REPORT_NAME}.txt
   fi
done
