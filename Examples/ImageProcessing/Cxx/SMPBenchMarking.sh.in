#!/bin/bash
TEST_PROGRAM_PATH=$1
O_PROFILE_ENABLE=$2
NUMBER_OF_TIMES_TEST=$3
TEST_PROGRAM_NUMBER=$4
ENABLESMP=$5
ENABLE_SMP_BLOCK_MODE=$6
THREAD_NUMBER=$7
SPLIT_SMP_BLOCKS=$8
WORK_LOAD=$9
O_PERF_EVENTS="${10}"
ROOT_FOLDER="${11}"
OUTPUT_CSV_FILE="${12}"
ADDITIONAL_DATA="${13}"

if [ $O_PROFILE_ENABLE -eq 1 ]; then
	# check if oprofile and oreport is installed if OPERF IS ENABLED
	hash operf 2>/dev/null || { echo >&2 "I require operf but it's not installed.  Aborting."; exit 1; }
	hash opreport 2>/dev/null || { echo >&2 "I require opreport but it's not installed.  Aborting."; exit 1; }
fi

REPORT_NAME=Run:${TEST_PROGRAM_NAME}-${TEST_PROGRAM_NUMBER}-${SPLIT_SMP_BLOCKS}-${THREAD_NUMBER}-${WORK_LOAD}-${NUMBER_OF_TIMES_TEST}

if [ $O_PROFILE_ENABLE -eq 0 ]; then
  $TEST_PROGRAM_PATH $NUMBER_OF_TIMES_TEST $TEST_PROGRAM_NUMBER $ENABLESMP $ENABLE_SMP_BLOCK_MODE $THREAD_NUMBER $SPLIT_SMP_BLOCKS $WORK_LOAD $OUTPUT_CSV_FILE $ADDITIONAL_DATA
else
 operf $O_PERF_EVENTS $TEST_PROGRAM_PATH $NUMBER_OF_TIMES_TEST $TEST_PROGRAM_NUMBER $ENABLESMP $ENABLE_SMP_BLOCK_MODE $THREAD_NUMBER $SPLIT_SMP_BLOCKS $WORK_LOAD $OUTPUT_CSV_FILE $ADDITIONAL_DATA
  opreport --callgraph -o $ROOT_FOLDER/$i${REPORT_NAME}.txt
fi
